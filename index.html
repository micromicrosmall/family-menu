<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶åº­åƒä»€ä¹ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            text-align: center;
        }
        
        .step {
            display: none;
            padding: 40px 30px;
        }
        
        .step.active {
            display: block;
        }
        
        .big-title {
            font-size: 72px;
            font-weight: 900;
            color: #333;
            margin-bottom: 50px;
            text-align: center;
        }
        
        .big-button {
            width: 90%;
            max-width: 350px;
            margin: 30px auto;
            padding: 35px 20px;
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            display: block;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .members-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 40px 0;
        }
        
        .member-btn {
            padding: 40px 20px;
            background: #f8f9fa;
            border: 4px solid #e9ecef;
            border-radius: 25px;
            font-size: 42px;
            font-weight: 800;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .member-btn.selected {
            background: #e3f2fd;
            border-color: #667eea;
            color: #667eea;
            transform: scale(1.05);
        }
        
        .member-btn:hover {
            transform: translateY(-5px);
        }
        
        .selected-count {
            font-size: 36px;
            color: #667eea;
            margin: 20px 0;
            min-height: 50px;
            font-weight: 700;
        }
        
        .meals-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin: 40px 0;
        }
        
        .meal-btn {
            padding: 45px 25px;
            font-size: 48px;
            font-weight: 800;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .breakfast { background: linear-gradient(135deg, #ff9a9e, #fad0c4); }
        .lunch { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); }
        .dinner { background: linear-gradient(135deg, #ffecd2, #fcb69f); }
        .snack { background: linear-gradient(135deg, #d4fc79, #96e6a1); }
        
        .meal-btn:hover {
            transform: translateY(-5px);
        }
        
        .result-container {
            background: #f8f9fa;
            border-radius: 25px;
            padding: 30px;
            margin: 30px 0;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .menu-display {
            font-size: 42px;
            font-weight: 800;
            color: #333;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .dish-item {
            padding: 10px 0;
            border-bottom: 1px dashed #ddd;
        }
        .dish-item:last-child {
            border-bottom: none;
        }
        
        .health-note {
            font-size: 28px;
            color: #666;
            line-height: 1.5;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 30px 40px;
            font-size: 36px;
            font-weight: 800;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            min-width: 200px;
            color: white;
        }
        
        .satisfied { background: #4CAF50; }
        .unsatisfied { background: #ff9800; } /* æ”¹ä¸ºæ©™è‰²ï¼Œæ›´ä¸­æ€§ */
        .change-btn { background: #2196F3; }
        .back-btn { 
            background: #757575;
            width: 100%;
            max-width: 400px;
            margin: 20px auto 0;
        }
        
        .satisfied:hover, .unsatisfied:hover, .change-btn:hover, .back-btn:hover {
            transform: translateY(-5px);
        }
        
        .info-badge {
            font-size: 24px;
            color: #666;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        @media (max-width: 480px) {
            .big-title { font-size: 56px; }
            .big-button { font-size: 36px; padding: 30px 15px; }
            .member-btn { font-size: 36px; padding: 30px 15px; }
            .meal-btn { font-size: 36px; padding: 35px 20px; }
            .menu-display { font-size: 36px; }
            .action-btn { font-size: 28px; padding: 25px 30px; min-width: 160px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="step active" id="step1">
        <div class="big-title">åƒä»€ä¹ˆï¼Ÿ</div>
        <button class="big-button" id="startBtn">å¼€å§‹</button>
        <div class="info-badge">ğŸ“ å››å· Â· å¥åº·å®šåˆ¶ Â· æ¯å‘¨ä¸é‡æ ·</div>
    </div>
    
    <div class="step" id="step2">
        <div class="big-title">è°åƒé¥­ï¼Ÿ</div>
        <div class="members-grid">
            <button class="member-btn" data-member="è€æ¯›">è€æ¯›</button>
            <button class="member-btn" data-member="è€å‘¨">è€å‘¨</button>
            <button class="member-btn" data-member="å°å‘¨">å°å‘¨</button>
            <button class="member-btn" data-member="å°æ">å°æ</button>
        </div>
        <div class="selected-count" id="selectedCount"></div>
        <button class="big-button" id="nextBtn" disabled>ä¸‹ä¸€æ­¥</button>
        <button class="back-btn action-btn" id="backBtn1">è¿”å›</button>
    </div>
    
    <div class="step" id="step3">
        <div class="big-title">åƒä»€ä¹ˆï¼Ÿ</div>
        <div class="meals-grid">
            <button class="meal-btn breakfast" data-meal="æ—©é¤">æ—©é¤</button>
            <button class="meal-btn lunch" data-meal="åˆé¤">åˆé¤</button>
            <button class="meal-btn dinner" data-meal="æ™šé¤">æ™šé¤</button>
            <button class="meal-btn snack" data-meal="åŠ é¤">åŠ é¤</button>
        </div>
        <button class="back-btn action-btn" id="backBtn2">è¿”å›</button>
    </div>
    
    <div class="step" id="step4">
        <div class="big-title" id="resultTitle"></div>
        <div class="result-container">
            <div class="menu-display" id="menuText"></div>
            <div class="health-note" id="healthNote"></div>
        </div>
        <div class="action-buttons">
            <button class="action-btn satisfied" id="likeBtn">æ»¡æ„</button>
            <button class="action-btn unsatisfied" id="dislikeBtn">æ¢æ¡Œèœ</button> <!-- æŒ‰é’®æ–‡æ¡ˆå·²æ”¹ -->
        </div>
        <button class="action-btn change-btn" id="changeBtn" style="display:none;">å†æ¢ä¸€æ¡Œ</button>
        <button class="back-btn action-btn" id="backBtn3">é‡æ–°é€‰æ‹©</button>
    </div>
</div>

<script>
// ==================== åŸºç¡€é…ç½® ====================
const CONFIG = {
    region: 'å››å·',
    season: 'å†¬å­£',
    weekDays: 7  // ç”¨äºå®ç°ä¸€å‘¨å†…ä¸é‡å¤
};

// ==================== å¥åº·éœ€æ±‚æ•°æ®åº“ ====================
const HEALTH_REQUIREMENTS = {
    'è€æ¯›': {
        gender: 'å¥³',
        age: 60,
        issues: ['èƒƒç—…', 'è‚ æ˜“æ¿€ç»¼åˆç—‡', 'å’³å—½', 'è‚ºç»“èŠ‚'],
        restrictions: ['å¿Œè¾›è¾£åˆºæ¿€', 'å¿Œç”Ÿå†·', 'å¿Œæ²¹è…»', 'å¿Œç²—çº¤ç»´', 'å¿Œäº§æ°”é£Ÿç‰©'],
        preferences: ['æ¸©å’Œæ˜“æ¶ˆåŒ–', 'æ¶¦è‚ºæ­¢å’³', 'å°‘é£Ÿå¤šé¤'],
        dislikes: ['é…¸å¥¶', 'å†·é¥®', 'ç¡¬é£Ÿ']
    },
    'è€å‘¨': {
        gender: 'ç”·',
        age: 60,
        issues: ['å°¿é…¸åé«˜', 'è¡€ç³–åé«˜'],
        restrictions: ['ä½å˜Œå‘¤é¥®é£Ÿ', 'ä½å‡ç³–æŒ‡æ•°', 'å¿Œæµ·é²œå†…è„', 'å¿Œæµ“æ±¤', 'å¿Œç”œé£Ÿ'],
        preferences: ['å¤šå–æ°´', 'ä¼˜è´¨è›‹ç™½', 'æ§åˆ¶ä¸»é£Ÿ'],
        dislikes: ['é…¸å¥¶', 'è±†åˆ¶å“', 'è‚¥è‚‰']
    },
    'å°å‘¨': {
        gender: 'ç”·',
        age: 34,
        issues: ['è‚ æ˜“æ¿€ç»¼åˆç—‡', 'æ˜“è¿‡æ•', 'èƒ†å›Šæ¯è‚‰'],
        restrictions: ['ä½FODMAPé£Ÿç‰©', 'é¿å…è¿‡æ•åŸ', 'ä½è„‚ä½èƒ†å›ºé†‡', 'å¿Œæ²¹ç‚¸', 'å¿Œæ²¹è…»'],
        preferences: ['æ¸©å’Œé¥®é£Ÿ', 'å……åˆ†ç…®ç†Ÿ', 'è§‚å¯Ÿè¿‡æ•ååº”'],
        dislikes: ['æµ·é²œ', 'åšæœ', 'æ²¹ç‚¸é£Ÿå“']
    },
    'å°æ': {
        gender: 'å¥³',
        age: 30,
        issues: ['ç”²çŠ¶è…ºç‚æ€§ç»“èŠ‚', 'åå¥½å·å‘³'],
        restrictions: ['æ§åˆ¶ç¢˜æ‘„å…¥', 'å¿Œæµ·å¸¦ç´«èœ', 'æ§åˆ¶è¾£åº¦'],
        preferences: ['å·èœé£å‘³', 'æŠ—æ°§åŒ–é£Ÿç‰©', 'é€‚é‡è¾£å‘³'],
        dislikes: ['è¿‡å¤šç¢˜', 'è¿‡è¾£']
    }
};

// ==================== ä¸°å¯Œçš„èœå“æ•°æ®åº“ï¼ˆå…·ä½“åŒ–ã€ä¸€å‘¨ä¸é‡å¤ï¼‰ ====================
const DISH_DATABASE = {
    // æ±¤ç±» (æ¯å‘¨ä¸é‡å¤)
    'æ±¤': [
        'ç™½èåœç‚–æ’éª¨æ±¤', 'ç•ªèŒ„è±†è…è‚‰ç‰‡æ±¤', 'è²è—•ç‰ç±³ç­’éª¨æ±¤', 'ç™½èœè±†è…ç²‰ä¸æ±¤',
        'é»„ç“œçš®è›‹ç˜¦è‚‰æ±¤', 'å†¬ç“œè–ç±³è€é¸­æ±¤', 'é…¸èœï¼ˆå°‘é‡ï¼‰è±†è…é±¼å¤´æ±¤',
        'ç´«èœè™¾çš®ï¼ˆå°‘é‡ï¼‰è›‹èŠ±æ±¤', 'èåœä¸é²«é±¼æ±¤', 'å±±è¯æ¸æä¹Œé¸¡æ±¤',
        'å†¬ç“œæµ·å¸¦æ’éª¨æ±¤', 'ç•ªèŒ„é‡‘é’ˆè‡è‚¥ç‰›æ±¤', 'è²è—•èŠ±ç”ŸçŒªè¹„æ±¤',
        'ç™½èœé¦™è‡ä¸¸å­æ±¤', 'é»„ç“œæœ¨è€³é¸¡è›‹æ±¤', 'å†¬ç“œè›¤èœŠæ±¤',
        'ç´«èœè‚‰æœ«è±†è…æ±¤', 'èåœç‰ç±³å¤§éª¨æ±¤', 'å±±è¯çº¢æ£é¸¡æ±¤',
        'å†¬ç“œé™ˆçš®è€é¸­æ±¤', 'ç•ªèŒ„é¾™åˆ©é±¼ç‰‡æ±¤', 'è²è—•è…”éª¨æ±¤',
        'ç™½èœè±†è…çŒªè¡€æ±¤', 'é»„ç“œç•ªèŒ„é¸¡è›‹æ±¤', 'å†¬ç“œä¸¸å­æ±¤'
    ],
    
    // è¤èœ (é±¼ç±»å…·ä½“åˆ°å“ç§ï¼Œæ¯å‘¨ä¸é‡å¤)
    'è¤èœ_é±¼': [
        'æ¸…è’¸é²ˆé±¼', 'æ¸…è’¸é³œé±¼', 'çº¢çƒ§å¸¦é±¼', 'è±†ç“£é²«é±¼',
        'è‘±æ²¹é²³é±¼', 'è±†è±‰è’¸é³Šé±¼', 'å®¶å¸¸çƒ§é»„è¾£ä¸', 'é…¸èœï¼ˆå°‘ï¼‰ä¹Œé±¼ç‰‡',
        'è’œçƒ§æ±Ÿå›¢', 'å¹²çƒ§å¹³é±¼', 'æ¸…è’¸å¤šå®é±¼', 'çº¢çƒ§é²¤é±¼å—',
        'æ¤’ç›å°é»„é±¼', 'é²œæ¤’é²¢é±¼å¤´', 'é…±ç„–å˜é±¼'
    ],
    'è¤èœ_ç¦½': [
        'å®«ä¿é¸¡ä¸ï¼ˆå°‘ç³–å°‘æ²¹ï¼‰', 'åœŸè±†çƒ§é¸¡ï¼ˆå»çš®ï¼‰', 'å±±è¯æ¸æç‚–ä¹Œé¸¡',
        'ç™½ç¼é¸¡èƒ¸è‚‰ä¸', 'æ¿æ —çƒ§é¸¡', 'ä¸‰æ¯é¸¡ï¼ˆå°‘æ²¹ï¼‰',
        'è‘±æ²¹æ·‹é¸¡', 'èŒ¶æ ‘è‡ç‚’é¸¡ä¸', 'ç«¹èªé¸¡æ±¤', 'é¸¡ç±³èŠ±ï¼ˆçƒ¤ç®±ç‰ˆï¼‰',
        'é’æ¤’é¸¡ä¸', 'å£æ°´é¸¡ï¼ˆå°‘è¾£ï¼‰', 'çº¢çƒ§é¸¡ç¿…', 'å°é¸¡ç‚–è˜‘è‡',
        'å§œæ¯é¸­', 'å•¤é…’é¸­', 'å¤é¸­èƒ—', 'çƒ¤é¸­ï¼ˆå»çš®ï¼‰'
    ],
    'è¤èœ_çŒª': [
        'å›é”…è‚‰ï¼ˆç˜¦è‚‰ä¸ºä¸»ï¼‰', 'æ°´ç…®è‚‰ç‰‡ï¼ˆå°‘è¾£ï¼‰', 'ç²‰è’¸æ’éª¨ï¼ˆå¤šå«çº¢è–¯ï¼‰',
        'è’œæ³¥ç™½è‚‰ï¼ˆç˜¦è‚‰ï¼‰', 'é±¼é¦™è‚‰ä¸ï¼ˆå°‘æ²¹ç³–ï¼‰', 'çº¢çƒ§ç‹®å­å¤´ï¼ˆæ¸…è’¸ï¼‰',
        'ç³–é†‹æ’éª¨ï¼ˆå°‘ç³–ï¼‰', 'æ¢…èœæ‰£è‚‰ï¼ˆå°‘åƒï¼‰', 'äº¬é…±è‚‰ä¸',
        'é’æ¤’è‚‰ä¸', 'å†¬ç“œçƒ§è‚‰ä¸¸', 'æ´‹è‘±ç‚’çŒªè‚ï¼ˆå°‘é‡ï¼‰',
        'ç¬‹å­çƒ§ç‰›è‚‰', 'ç•ªèŒ„ç‚–ç‰›è…©', 'é»‘æ¤’ç‰›æŸ³', 'èåœçƒ§ç¾Šè‚‰'
    ],
    'è¤èœ_å…¶ä»–': [
        'éº»å©†è±†è…ï¼ˆå¾®è¾£å°‘æ²¹ï¼‰', 'è‚‰æœ«è’¸è›‹', 'è›¤èœŠè’¸è›‹',
        'è™¾ä»ç‚’è›‹', 'éŸ­èœç‚’é¦™å¹²', 'è‚‰æœ«çƒ§è±†è…'
    ],
    
    // ç´ èœ (æ¯å‘¨ä¸é‡å¤)
    'ç´ èœ': [
        'è’œè“‰è èœ', 'æ¸…ç‚’è±Œè±†å°–', 'èšæ²¹ç”Ÿèœ', 'ç™½ç¼èœå¿ƒ',
        'æ¸…ç‚’è·å…°è±†', 'é†‹æºœç™½èœ', 'é±¼é¦™èŒ„å­ï¼ˆå°‘æ²¹ï¼‰', 'åœ°ä¸‰é²œï¼ˆå°‘æ²¹ï¼‰',
        'å¹²ç…¸å››å­£è±†ï¼ˆå°‘æ²¹ï¼‰', 'æ¸…ç‚’è¥¿å…°èŠ±', 'ç•ªèŒ„ç‚’è›‹', 'è‹¦ç“œç‚’è›‹',
        'è™çš®é’æ¤’', 'æ¸…ç‚’ä¸ç“œ', 'ç‚ç‚’è²ç™½', 'æ¸…ç‚’è´ç¬‹ä¸',
        'è¥¿èŠ¹ç™¾åˆ', 'æ¸…ç‚’å„¿èœ', 'æ¸…ç‚’ç“¢å„¿ç™½', 'æ¸…ç‚’è±†è‹—',
        'é¦™è‡æ²¹èœ', 'æ¸…ç‚’å±±è¯ç‰‡', 'æ¸…ç‚’å—ç“œ', 'æ¸…ç‚’å†¬ç“œ',
        'å‡‰æ‹Œä¸‰ä¸ï¼ˆèƒ¡èåœé’ç¬‹è±†è…çš®ï¼‰', 'å‡‰æ‹Œé»„ç“œ', 'æ‰‹æ’•æé²è‡'
    ]
};

// ==================== æ—©é¤ä¸åŠ é¤æ•°æ®åº“ ====================
const MEAL_DATABASE = {
    'æ—©é¤': {
        'è€æ¯›': [
            'çº¢æ£é“¶è€³ç¾¹ï¼ˆæ— ç³–ï¼‰+ è’¸çº¢è–¯', 'å°ç±³å±±è¯ç²¥ + å…¨éº¦é¦’å¤´', 'è’¸è›‹ç¾¹ + å—ç“œç²¥',
            'èƒ¡èåœå¤§ç±³ç²¥ + è’¸é¥ºï¼ˆç™½èœé¸¡è‚‰ï¼‰', 'ç‡•éº¦ç‰›å¥¶ç³Šï¼ˆæ¸©çƒ­ï¼‰+ ç…®é¸¡è›‹',
            'é†ªç³Ÿå°æ±¤åœ†ï¼ˆå°‘ç³–ï¼‰+ è’¸èŠ‹å¤´', 'è”¬èœç²¥ï¼ˆå¤§ç±³èƒ¡èåœè èœï¼‰'
        ],
        'è€å‘¨': [
            'ç‡•éº¦å°ç±³ç²¥ + è’¸è›‹ç¾¹', 'å…¨éº¦é¦’å¤´ + è’¸çº¢è–¯', 'è”¬èœç²¥ï¼ˆä½ç›ï¼‰',
            'èéº¦é¢æ¡ï¼ˆæ¸…æ±¤é¸¡ä¸é’èœï¼‰', 'å°ç±³ç²¥ + è’¸é¥ºï¼ˆç™½èœé¸¡è‚‰ï¼‰',
            'è±†æµ†ï¼ˆæ— ç³–ï¼‰ + å…¨éº¦èŠ±å·', 'ç‰ç±³ç²¥ + ç…®é¸¡è›‹'
        ],
        'å°å‘¨': [
            'å°ç±³ç²¥ + è’¸è›‹', 'ç™½ç²¥ + è’¸é¥ºï¼ˆç™½èœé¸¡è‚‰ï¼‰', 'è”¬èœç²¥ï¼ˆæ¸©å’Œï¼‰',
            'è’¸çº¢è–¯ + è’¸è›‹ç¾¹', 'ç™½é¦’å¤´ + è’¸å—ç“œ', 'ç™½ç²¥ + è‚‰æ¾ï¼ˆå°‘é‡ï¼‰',
            'è’¸èŠ‹å¤´ + è’¸è›‹'
        ],
        'å°æ': [
            'é†ªç³Ÿè›‹èŠ±æ±¤åœ†ï¼ˆå°‘ç³–ï¼‰', 'æ‹…æ‹…é¢ï¼ˆå¾®è¾£å°‘æ²¹ï¼‰', 'éº»è¾£å°é¢ï¼ˆå°‘è¾£ï¼‰',
            'é…¸è¾£ç²‰ï¼ˆå¾®è¾£ï¼‰', 'è±†æµ† + æ²¹æ¡ï¼ˆå°‘é‡ï¼‰', 'ç²¥ + å››å·æ³¡èœ',
            'ç‰›å¥¶ç‡•éº¦ + åšæœ'
        ]
    },
    'åŠ é¤': {
        'è€æ¯›': ['è’¸è‹¹æœ', 'é¦™è•‰ï¼ˆç†Ÿï¼‰', 'é›ªæ¢¨ç¾¹', 'çº¢æ£æ±¤', 'è—•ç²‰ç¾¹', 'è’¸å±±è¯', 'çƒ¤çº¢è–¯'],
        'è€å‘¨': ['è‹¹æœï¼ˆå»çš®ï¼‰', 'æ©™å­', 'é›ªæ¢¨ï¼ˆç‚–ï¼‰', 'é»„ç“œ', 'æŸšå­', 'è’¸è‹¹æœ', 'ç«é¾™æœï¼ˆç™½å¿ƒï¼‰'],
        'å°å‘¨': ['è‹¹æœï¼ˆå»çš®ï¼‰', 'é¦™è•‰ï¼ˆç†Ÿï¼‰', 'é›ªæ¢¨ï¼ˆå»çš®ï¼‰', 'è’¸å—ç“œ', 'çƒ¤çº¢è–¯', 'è’¸è‹¹æœ', 'ç±³ç³•'],
        'å°æ': ['å†°ç²‰', 'å‡‰ç³•', 'çº¢ç³–é”…ç›”ï¼ˆå°‘é‡ï¼‰', 'æ°´æœæ‹¼ç›˜', 'åšæœ', 'è›‹çƒ˜ç³•', 'é†ªç³Ÿ']
    }
};

// ==================== æ ¸å¿ƒçŠ¶æ€ ====================
const tracker = { records: [] }; // ç®€åŒ–æ»¡æ„åº¦è®°å½•
let selectedMembers = [];
let currentMeal = '';
let usedDishesThisWeek = JSON.parse(localStorage.getItem('usedDishes')) || { 'æ±¤': [], 'è¤': [], 'ç´ ': [] };
let currentDayIndex = new Date().getDay(); // 0-6, ç”¨äºä¸€å‘¨è½®æ¢

// ==================== ä¸»é€»è¾‘å‡½æ•° ====================
function getRandomDish(category, subCategory = null) {
    let pool = subCategory ? DISH_DATABASE[`${category}_${subCategory}`] : DISH_DATABASE[category];
    // è¿‡æ»¤æ‰æœ¬å‘¨å·²ä½¿ç”¨çš„èœå“
    let availableDishes = pool.filter(dish => !usedDishesThisWeek[category[0]].includes(dish));
    
    // å¦‚æœå¯ç”¨èœå“ä¸è¶³ï¼Œæ¸…ç©ºæœ¬å‘¨è®°å½•é‡æ–°å¼€å§‹
    if (availableDishes.length < 3) {
        usedDishesThisWeek[category[0]] = [];
        availableDishes = pool;
    }
    
    const selectedDish = availableDishes[Math.floor(Math.random() * availableDishes.length)];
    usedDishesThisWeek[category[0]].push(selectedDish);
    localStorage.setItem('usedDishes', JSON.stringify(usedDishesThisWeek));
    return selectedDish;
}

function generateLunchDinnerMenu(peopleCount) {
    let menu = [];
    let dishCounts = { æ±¤: 1, è¤: 0, ç´ : 0 };
    
    // æ ¹æ®äººæ•°ç¡®å®šè¤ç´ æ•°é‡
    switch(peopleCount) {
        case 1: dishCounts.è¤ = 1; dishCounts.ç´  = 1; break; // ä¸€è¤ä¸€ç´ ä¸€æ±¤
        case 2: dishCounts.è¤ = 2; dishCounts.ç´  = 1; break; // ä¸¤è¤ä¸€ç´ ä¸€æ±¤
        case 3: 
            // ä¸‰è¤ä¸€ç´ æˆ–ä¸¤è¤ä¸¤ç´ éšæœº
            if (Math.random() > 0.5) { dishCounts.è¤ = 3; dishCounts.ç´  = 1; }
            else { dishCounts.è¤ = 2; dishCounts.ç´  = 2; }
            break;
        case 4: dishCounts.è¤ = 3; dishCounts.ç´  = 2; break; // ä¸‰è¤ä¸¤ç´ ä¸€æ±¤
    }
    
    // ç”Ÿæˆæ±¤
    menu.push(`ğŸ² ${getRandomDish('æ±¤')}`);
    
    // ç”Ÿæˆè¤èœï¼ˆè€ƒè™‘å¥åº·éœ€æ±‚ï¼Œä¼˜å…ˆé€‰æ‹©ä½è„‚ä½å˜Œå‘¤çš„é±¼å’Œç¦½ï¼‰
    let meatTypes = ['é±¼', 'ç¦½', 'çŒª', 'å…¶ä»–'];
    for (let i = 0; i < dishCounts.è¤; i++) {
        let selectedType = meatTypes[i % meatTypes.length];
        menu.push(`ğŸ– ${getRandomDish('è¤èœ', selectedType)}`);
    }
    
    // ç”Ÿæˆç´ èœ
    for (let i = 0; i < dishCounts.ç´ ; i++) {
        menu.push(`ğŸ¥¬ ${getRandomDish('ç´ èœ')}`);
    }
    
    return menu;
}

function generateMenu() {
    if (selectedMembers.length === 0 || !currentMeal) return;
    
    document.getElementById('resultTitle').textContent = `${selectedMembers.join('ã€')}çš„${currentMeal}`;
    let menuItems = [];
    let healthNotes = [];
    
    if (currentMeal === 'æ—©é¤' || currentMeal === 'åŠ é¤') {
        selectedMembers.forEach(member => {
            const recipes = MEAL_DATABASE[currentMeal][member];
            const recipe = recipes[currentDayIndex % recipes.length];
            menuItems.push(`ğŸ½ï¸ ${member}ï¼š${recipe}`);
            healthNotes.push(`${member}ï¼š${HEALTH_REQUIREMENTS[member].restrictions.slice(0, 2).join('ï¼Œ')}`);
        });
    } else {
        // åˆé¤å’Œæ™šé¤
        menuItems = generateLunchDinnerMenu(selectedMembers.length);
        selectedMembers.forEach(member => {
            healthNotes.push(`${member}ï¼š${HEALTH_REQUIREMENTS[member].issues.slice(0, 2).join('ï¼Œ')}`);
        });
    }
    
    // æ›´æ–°æ˜¾ç¤º
    const menuHtml = menuItems.map(item => `<div class="dish-item">${item}</div>`).join('');
    document.getElementById('menuText').innerHTML = menuHtml;
    document.getElementById('healthNote').textContent = `å¥åº·æç¤ºï¼š${[...new Set(healthNotes)].join('ï¼›')}`;
    
    // éšè—â€œå†æ¢ä¸€æ¡Œâ€æŒ‰é’®ï¼Œç›´åˆ°ç‚¹å‡»â€œæ¢æ¡Œèœâ€
    document.getElementById('changeBtn').style.display = 'none';
}

// ==================== äº‹ä»¶ç»‘å®šä¸åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', function() {
    // ç»‘å®šæ­¥éª¤æŒ‰é’®
    document.getElementById('startBtn').addEventListener('click', () => showStep(2));
    document.getElementById('nextBtn').addEventListener('click', () => showStep(3));
    document.getElementById('backBtn1').addEventListener('click', () => showStep(1));
    document.getElementById('backBtn2').addEventListener('click', () => showStep(2));
    document.getElementById('backBtn3').addEventListener('click', resetSelection);
    
    // ç»‘å®šæˆå‘˜é€‰æ‹©
    document.querySelectorAll('.member-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const member = this.getAttribute('data-member');
            toggleMember(member);
        });
    });
    
    // ç»‘å®šé¤åˆ«é€‰æ‹©
    document.querySelectorAll('.meal-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentMeal = this.getAttribute('data-meal');
            showStep(4);
            generateMenu();
        });
    });
    
    // ç»‘å®šæ»¡æ„åº¦æŒ‰é’®
    document.getElementById('likeBtn').addEventListener('click', () => {
        alert('âœ… å·²è®°å½•æ‚¨çš„æ»¡æ„é€‰æ‹©ï¼');
        resetToStart();
    });
    
    // ç»‘å®šâ€œæ¢æ¡Œèœâ€æŒ‰é’®
    document.getElementById('dislikeBtn').addEventListener('click', () => {
        // ç‚¹å‡»â€œæ¢æ¡Œèœâ€åï¼Œæ˜¾ç¤ºâ€œå†æ¢ä¸€æ¡Œâ€æŒ‰é’®ï¼Œå¹¶ç«‹å³ç”Ÿæˆä¸€æ¡Œæ–°èœ
        document.getElementById('changeBtn').style.display = 'block';
        generateMenu(); // é‡æ–°ç”Ÿæˆèœå•
    });
    
    // ç»‘å®šâ€œå†æ¢ä¸€æ¡Œâ€æŒ‰é’®
    document.getElementById('changeBtn').addEventListener('click', generateMenu);
});

// ==================== é€šç”¨å·¥å…·å‡½æ•° ====================
function showStep(stepNumber) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${stepNumber}`).classList.add('active');
    if (stepNumber === 2) updateSelectedCount();
}

function toggleMember(member) {
    const idx = selectedMembers.indexOf(member);
    if (idx === -1) selectedMembers.push(member);
    else selectedMembers.splice(idx, 1);
    
    document.querySelectorAll('.member-btn').forEach(btn => {
        if (btn.getAttribute('data-member') === member) btn.classList.toggle('selected');
    });
    
    updateSelectedCount();
    document.getElementById('nextBtn').disabled = selectedMembers.length === 0;
}

function updateSelectedCount() {
    const display = document.getElementById('selectedCount');
    if (selectedMembers.length === 0) {
        display.textContent = 'è¯·é€‰æ‹©åƒé¥­çš„äºº';
        display.style.color = '#999';
    } else {
        display.textContent = `å·²é€‰ ${selectedMembers.length} äººï¼š${selectedMembers.join('ã€')}`;
        display.style.color = '#667eea';
    }
}

function recordSatisfaction(satisfied) {
    tracker.records.push({ date: new Date().toISOString(), satisfied });
}

function resetToStart() {
    selectedMembers = [];
    currentMeal = '';
    document.querySelectorAll('.member-btn').forEach(btn => btn.classList.remove('selected'));
    showStep(1);
}

function resetSelection() {
    showStep(2);
}
</script>
</body>
</html>
